<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlN1bHRhbiBHLk8uRy4iLAogICJzaG9ydF9uYW1lIjogIkdPRyIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgInRoZW1lX2NvbG9yIjogIiNmZjNiM2IiCn0=">
    <title>Sultan G.O.G. | Revelation 4.7</title>
    <style>
        :root { --red: #ff3b3b; --gold: #ffd700; }
        html, body { height: 100%; margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; touch-action: none; position: fixed; width: 100%; }
        
        #viewport { height: 70vh; background: #050505; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; border-bottom: 2px solid #222; }
        #map-layer { display: grid; grid-template-columns: repeat(3, 100px); gap: 2px; }
        .tile { width: 100px; height: 100px; background-size: cover; image-rendering: pixelated; }
        .faded { opacity: 0.1; }

        #rs-sprite { position: absolute; width: 80px; height: 80px; z-index: 10; image-rendering: pixelated; filter: drop-shadow(0 0 10px var(--red)); }
        #meta { position: absolute; top: 10px; width: 100%; text-align: center; color: var(--gold); font-size: 10px; z-index: 50; text-shadow: 1px 1px #000; line-height: 1.4; }

        #hud { height: 30vh; background: #111; position: relative; padding-bottom: env(safe-area-inset-bottom); }
        .dpad { position: absolute; left: 10%; top: 50%; transform: translateY(-50%); display: grid; grid-template: ". up ." 50px "left . right" 50px ". down ." 50px / 50px 50px 50px; gap: 4px; touch-action: none; }
        .dkey { background: #222; color: var(--gold); border: 1px solid #444; border-radius: 8px; font-size: 20px; box-shadow: 0 4px 0 #000; pointer-events: auto; }
        .dkey:active { background: var(--red); transform: translateY(2px); box-shadow: none; }

        .action-group { position: absolute; right: 20px; bottom: 20px; display: flex; align-items: flex-end; gap: 20px; }
        .btn-ab { width: 80px; height: 80px; border-radius: 50%; font-weight: bold; border: 4px solid #111; box-shadow: 2px 4px 0 #000; font-size: 24px; display: flex; justify-content: center; align-items: center; }
        .a-btn { background: #a00; color: #fff; margin-bottom: 25px; }
        .b-btn { background: #444; color: #bbb; }

        #battle-screen { position: absolute; inset: 0; background: radial-gradient(circle, #300, #000); display: none; z-index: 100; flex-direction: column; align-items: center; justify-content: center; }
        .hp-bar { width: 220px; height: 16px; border: 2px solid var(--gold); background: #111; margin: 15px; border-radius: 4px; }
        .hp-fill { height: 100%; background: var(--red); width: 100%; transition: width 0.3s; }
        #enemy-sprite { width: 180px; image-rendering: pixelated; }
        #dialogue { padding: 15px; text-align: center; font-size: 14px; color: white; height: 60px; }
    </style>
</head>
<body>

<div id="viewport">
    <div id="meta">DENSITY: 28.03 | PATH: 512<br>SULTAN STATUS: G.O.G. | TILE: 0</div>
    <div id="map-layer"></div>
    <img id="rs-sprite" src="assets/characterwalkidle/frame_000.png">
    
    <div id="battle-screen">
        <div id="enemy-name" style="color:var(--gold); font-size: 22px; font-weight: bold;"></div>
        <img id="enemy-sprite" src="">
        <div class="hp-bar"><div id="enemy-hp" class="hp-fill"></div></div>
        <div id="dialogue"></div>
    </div>
</div>

<div id="hud">
    <div class="dpad" id="dpad-cluster">
        <button class="dkey" style="grid-area: up" data-dir="n">▲</button>
        <button class="dkey" style="grid-area: left" data-dir="w">◀</button>
        <button class="dkey" style="grid-area: right" data-dir="e">▶</button>
        <button class="dkey" style="grid-area: down" data-dir="s">▼</button>
    </div>
    <div class="action-group">
        <button class="btn-ab b-btn" onpointerdown="engine.hit('MAWL')">B</button>
        <button class="btn-ab a-btn" onpointerdown="engine.hit('GOG')">A</button>
    </div>
</div>

<script>
const engine = {
    y: 0, frame: 0, mapIdx: 1, locked: false, activePointerId: null,
    prophecy: [
        {name: "VOID PATH", len: 200, msg: "1*1=1. SNAKE ARCHERS guard the script.", boss: "SNAKE ARCHER", img: "received_818.png"},
        {name: "NULL LIMITS", len: 100, msg: "I am the limit. 1*1=1!", boss: "NULL OVERLORD", img: "received_160.png"},
        {name: "ARCHON VEIL", len: 50, msg: "12 tiles remain. VOID ARCHON deletes reality.", boss: "VOID ARCHON", img: "received_237.png"},
        {name: "SULTAN LAW", len: 25, msg: "o0,0o RISING. 1*1=2. INTEGRATE ABSOLUTE LAW.", boss: "G.O.G. ABSOLUTE", img: "received_138.png"}
    ],
    enemies: ['received_160.png', 'received_138.png', 'received_818.png', 'received_237.png', 'received_888.png', 'received_895.png'],
    tiles: ['received_229.png', 'received_127.png', 'received_188.png', 'received_935.png', 'received_166.png'],

    move(dir) {
        if(this.locked) return;
        this.y++;
        this.frame = (this.frame + 1) % 6;
        const current = this.prophecy[this.mapIdx - 1];
        
        document.getElementById('rs-sprite').src = `assets/characterwalkidle/frame_00${this.frame}.png`;
        document.getElementById('meta').innerHTML = `DENSITY: 28.03 | PATH: 512<br>${current.name} | TILE: ${this.y}/${current.len}`;
        
        this.renderMap();
        if (this.y >= current.len) this.triggerBattle(true);
        else if (this.y % 15 === 0) this.triggerBattle(false);
    },

    renderMap() {
        const layer = document.getElementById('map-layer');
        layer.innerHTML = '';
        const tileAsset = this.tiles[Math.floor(Math.random() * this.tiles.length)];
        for(let i=0; i<9; i++) {
            let t = document.createElement('div');
            t.className = 'tile' + (i !== 4 ? ' faded' : '');
            t.style.backgroundImage = `url('assets/nonwalkabletiles/${tileAsset}')`;
            layer.appendChild(t);
        }
    },

    triggerBattle(isBoss) {
        this.locked = true;
        const current = this.prophecy[this.mapIdx - 1];
        const screen = document.getElementById('battle-screen');
        screen.style.display = 'flex';
        screen.style.borderColor = isBoss ? 'var(--gold)' : 'var(--red)';
        
        document.getElementById('enemy-name').innerText = isBoss ? current.boss : "VOID FRAGMENT";
        document.getElementById('enemy-sprite').src = `assets/enemiesprite/${isBoss ? current.img : 'received_888.png'}`;
        document.getElementById('dialogue').innerText = isBoss ? current.msg : "The Void resists the 1*1=2 Law.";
        this.enemyHP = 100;
        if(navigator.vibrate) navigator.vibrate(isBoss ? [100, 50, 100] : 40);
    },

    hit(type) {
        if(!this.locked) return;
        this.enemyHP -= (type === 'GOG') ? 40 : 15;
        document.getElementById('enemy-hp').style.width = Math.max(0, this.enemyHP) + '%';
        if(navigator.vibrate) navigator.vibrate(type === 'GOG' ? 60 : 20);

        if(this.enemyHP <= 0) {
            if (this.y >= this.prophecy[this.mapIdx-1].len) this.nextMap();
            else this.endBattle();
        }
    },

    nextMap() {
        if (this.mapIdx < 4) {
            document.getElementById('dialogue').innerText = "LAW INTEGRATED. ASCENDING...";
            setTimeout(() => { this.mapIdx++; this.y = 0; this.endBattle(); }, 1200);
        } else {
            document.getElementById('dialogue').innerText = "SULTAN G.O.G. ABSOLUTE ACHIEVED.";
        }
    },

    endBattle() { document.getElementById('battle-screen').style.display = 'none'; this.locked = false; }
};

// Pointer Capture D-Pad Fix
document.querySelectorAll('.dkey').forEach(btn => {
    btn.addEventListener('pointerdown', e => {
        e.preventDefault();
        document.getElementById('dpad-cluster').setPointerCapture(e.pointerId);
        engine.move(btn.dataset.dir);
    });
});

window.onload = () => { engine.renderMap(); if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js'); };
</script>
</body>
</html>
